<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Jett - Extreme Heights Edition</title>
    <style>
        body { margin: 0; overflow: hidden; background: #3d2b1f; font-family: 'Segoe UI', sans-serif; }
        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 4px; height: 4px;
            background: #00ffff; border-radius: 50%; transform: translate(-50%, -50%);
            pointer-events: none; z-index: 10; border: 1px solid rgba(0,0,0,0.8);
        }
        #ui {
            position: absolute; top: 20px; left: 20px; color: #fff;
            background: rgba(0,0,0,0.7); padding: 15px; border-radius: 5px; border-left: 5px solid #ff4655; z-index: 10;
        }
        #weapon-ui {
            position: absolute; bottom: 30px; right: 30px; color: #fff;
            background: rgba(0,0,0,0.8); padding: 15px; border-radius: 5px; font-weight: bold; font-size: 20px;
        }
        #kill-banner {
            position: absolute; bottom: 15%; left: 50%; transform: translateX(-50%) scale(0);
            background: linear-gradient(transparent, rgba(255, 70, 85, 0.8), transparent);
            color: white; padding: 10px 40px; font-size: 30px; font-weight: 900;
            text-shadow: 2px 2px #000; transition: transform 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none; z-index: 20; border-top: 2px solid #fff; border-bottom: 2px solid #fff;
        }
        #dash-indicator {
            position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%);
            color: #00ffff; font-weight: bold; font-size: 18px; display: none; text-shadow: 0 0 10px #00ffff;
        }
        #settings {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 300px; background: #1f2326; color: white; padding: 25px;
            border-radius: 8px; display: none; z-index: 101; border-top: 5px solid #ff4655;
        }
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center;
            color: white; text-align: center; z-index: 100; cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="overlay">
        <div>
            <h1 style="color:#ff4655">JETT EXTREME HEIGHTS</h1>
            <p>BẤM ĐỂ BẮT ĐẦU</p>
            <p style="font-size:13px; color:#ccc;">THÙNG CAO VÀ NHIỀU HƠN | Q ĐỂ BAY CAO | SPACE ĐỂ LƯỢN</p>
        </div>
    </div>

    <div id="kill-banner">KILLED</div>
    <div id="dash-indicator">TAILWIND READY</div>
    <div id="crosshair"></div>
    <div id="ui"><h2>JETT ARSENAL</h2>Kills: <span id="kC">0</span></div>
    <div id="weapon-ui">VANDAL</div>

    <div id="settings">
        <h3 style="color:#ff4655; margin-top:0">CÀI ĐẶT</h3>
        <label>Độ nhạy: <span id="sVal">2.0</span></label>
        <input type="range" id="sIn" min="0.1" max="5" step="0.1" value="2">
        <br><br>
        <label>Âm lượng: <span id="vVal">50</span>%</label>
        <input type="range" id="vIn" min="0" max="100" value="50">
        <br><br>
        <button id="closeBtn" style="width:100%; padding:10px; background:#ff4655; color:white; border:none; cursor:pointer;">LƯU</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.min.js"></script>

    <script>
        let audioCtx;
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87ceeb);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        scene.add(new THREE.AmbientLight(0xffffff, 1.2));
        const sun = new THREE.DirectionalLight(0xffffff, 0.8);
        sun.position.set(20, 100, 20); // Mặt trời cao hơn
        scene.add(sun);

        // --- MAP & THÙNG (BOXES) ---
        const pal = { oak: 0x2e1d0b, cobble: 0x5a5a5a, box: 0xd2a679 };
        const colliders = [];
        function createBox(w, h, d, x, y, z, color) {
            const mesh = new THREE.Mesh(new THREE.BoxGeometry(w, h, d), new THREE.MeshStandardMaterial({ color }));
            mesh.position.set(x, y, z);
            scene.add(mesh);
            colliders.push({ box: new THREE.Box3().setFromObject(mesh), top: y + h/2 });
        }

        // Sàn và Tường (Tường cao hơn 30m)
        createBox(200, 1, 200, 0, -0.5, 0, pal.oak);
        createBox(2, 30, 100, -50, 15, 0, pal.cobble);
        createBox(2, 30, 100, 50, 15, 0, pal.cobble);
        createBox(100, 30, 2, 0, 15, -50, pal.cobble);

        // THÊM SỐ LƯỢNG THÙNG (40 THÙNG) VÀ ĐỘ CAO (LÊN TỚI 15M)
        for(let i=0; i<40; i++) {
            let bx = Math.random()*80 - 40;
            let bz = Math.random()*80 - 40;
            let bh = 2 + Math.random()*13; // Thùng cao từ 2m đến 15m
            createBox(2.5, bh, 2.5, bx, bh/2, bz, pal.box);
        }

        // --- VẬT LÝ JETT & SÚNG (GIỮ NGUYÊN BẢN TRƯỚC) ---
        const gunPivot = new THREE.Group();
        camera.add(gunPivot);
        scene.add(camera);
        const models = {
            vandal: new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.2, 0.8), new THREE.MeshStandardMaterial({color: 0x222})),
            sheriff: new THREE.Mesh(new THREE.BoxGeometry(0.12, 0.25, 0.4), new THREE.MeshStandardMaterial({color: 0x444}))
        };
        let curW = 'vandal';
        function switchW(t) { curW=t; gunPivot.clear(); gunPivot.add(models[t]); models[t].position.set(0.4, -0.4, -0.6); document.getElementById('weapon-ui').innerText=t.toUpperCase(); }
        switchW('vandal');

        function playSfx(f, d, type='square', v=0.05) {
            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const vol = document.getElementById('vIn').value / 100;
            const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
            o.type = type; o.frequency.value = f;
            g.gain.setValueAtTime(v * vol, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + d);
            o.connect(g); g.connect(audioCtx.destination);
            o.start(); o.stop(audioCtx.currentTime + d);
        }

        let vY = 0, isG = true, canD = true, dashReady = false, dashActive = 0, dashDir = new THREE.Vector3(), dashYLock = 0;
        let kills = 0, botHP = 100, isFiring = false, lastFire = 0;
        const keys = {};

        window.onkeydown = (e) => {
            keys[e.code] = true;
            if(e.code === 'Digit1') switchW('vandal');
            if(e.code === 'Digit2') switchW('sheriff');
            if(e.code === 'KeyQ') { vY = 0.45; isG = false; playSfx(500, 0.2, 'sine'); } // Updraft mạnh hơn một chút
            if(e.code === 'KeyE' && canD) {
                if(!dashReady) {
                    dashReady = true; document.getElementById('dash-indicator').style.display = 'block';
                    playSfx(800, 0.1, 'sine', 0.02);
                } else {
                    let mx = 0, mz = 0;
                    if(keys['KeyW']) mz -= 1; if(keys['KeyS']) mz += 1;
                    if(keys['KeyA']) mx -= 1; if(keys['KeyD']) mx += 1;
                    if(mx === 0 && mz === 0) camera.getWorldDirection(dashDir);
                    else dashDir.set(mx, 0, mz).applyQuaternion(camera.quaternion);
                    dashDir.y = 0; dashDir.normalize();
                    dashActive = 30; dashYLock = 12; dashReady = false; canD = false;
                    document.getElementById('dash-indicator').style.display = 'none';
                    setTimeout(() => canD = true, 2000);
                    playSfx(200, 0.3, 'sawtooth');
                }
            }
        };
        window.onkeyup = (e) => keys[e.code] = false;

        let bot = new THREE.Group();
        function spawnBot() {
            scene.remove(bot); bot = new THREE.Group(); botHP = 100;
            const b = new THREE.Mesh(new THREE.BoxGeometry(0.8, 1.6, 0.6), new THREE.MeshStandardMaterial({color: 0x00ff00, emissive: 0x004400}));
            b.position.y = 0.8; b.userData.type = 'body';
            const h = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.5, 0.5), new THREE.MeshStandardMaterial({color: 0xff0000, emissive: 0x660000}));
            h.position.y = 1.8; h.userData.type = 'head';
            bot.add(b, h);
            // Bot cũng có thể spawn trên các thùng cao
            let randomIdx = Math.floor(Math.random() * colliders.length);
            let targetBox = colliders[randomIdx];
            bot.position.set(targetBox.box.getCenter(new THREE.Vector3()).x, targetBox.top, targetBox.box.getCenter(new THREE.Vector3()).z);
            scene.add(bot);
        }
        spawnBot();

        function triggerKillEffect() {
            playSfx(1000, 0.1, 'sine', 0.3); setTimeout(() => playSfx(1500, 0.1, 'sine', 0.2), 50);
            const banner = document.getElementById('kill-banner');
            banner.style.transform = 'translateX(-50%) scale(1.2)';
            setTimeout(() => { banner.style.transform = 'translateX(-50%) scale(0)'; }, 800);
        }

        const ray = new THREE.Raycaster();
        function shoot() {
            const now = Date.now();
            if (now - lastFire < (curW === 'vandal' ? 120 : 500)) return;
            lastFire = now;
            playSfx(curW === 'vandal' ? 160 : 80, 0.15, 'square', 0.1);
            gunPivot.position.z += 0.2; setTimeout(()=>gunPivot.position.z=0, 60);
            ray.setFromCamera(new THREE.Vector2(0,0), camera);
            const hits = ray.intersectObjects(bot.children);
            if(hits.length > 0) {
                if(hits[0].object.userData.type === 'head') botHP = 0;
                else botHP -= (curW === 'vandal' ? 35 : 60);
                if(botHP <= 0) { kills++; document.getElementById('kC').innerText = kills; triggerKillEffect(); spawnBot(); }
            }
        }

        window.onmousemove = (e) => {
            if(document.pointerLockElement === renderer.domElement) {
                const s = document.getElementById('sIn').value * 0.001;
                camera.rotation.y -= e.movementX * s;
                camera.rotation.x -= e.movementY * s;
                camera.rotation.x = Math.max(-1.5, Math.min(1.5, camera.rotation.x));
            }
        };

        function animate() {
            requestAnimationFrame(animate);
            if(document.pointerLockElement === renderer.domElement) {
                const spd = 0.07, old = camera.position.clone();
                if(dashActive > 0) { camera.position.addScaledVector(dashDir, 0.4); dashActive--; if(dashYLock > 0) { vY = 0; dashYLock--; } }
                else { if(keys['KeyW']) camera.translateZ(-spd); if(keys['KeyS']) camera.translateZ(spd); if(keys['KeyA']) camera.translateX(-spd); if(keys['KeyD']) camera.translateX(spd); }
                let g = -0.005;
                if(!isG) { if(keys['Space'] && vY < 0) { g = -0.0008; vY = Math.max(vY, -0.02); } vY += g; }
                camera.position.y += vY;
                let gY = 2.0;
                for(let c of colliders) {
                    const p = camera.position;
                    if(p.x > c.box.min.x-0.6 && p.x < c.box.max.x+0.6 && p.z > c.box.min.z-0.6 && p.z < c.box.max.z+0.6) {
                        if(old.y >= c.top + 1.5) gY = c.top + 2.0;
                        else { camera.position.x = old.x; camera.position.z = old.z; }
                    }
                }
                if(camera.position.y <= gY) { camera.position.y = gY; vY = 0; isG = true; } else isG = false;
                if(isFiring) shoot();
            }
            renderer.render(scene, camera);
        }

        document.getElementById('overlay').onclick = () => renderer.domElement.requestPointerLock();
        document.getElementById('closeBtn').onclick = () => renderer.domElement.requestPointerLock();
        document.addEventListener('pointerlockchange', () => {
            const locked = document.pointerLockElement === renderer.domElement;
            document.getElementById('overlay').style.display = locked ? 'none' : 'flex';
            document.getElementById('settings').style.display = locked ? 'none' : 'block';
        });
        document.getElementById('sIn').oninput = (e) => document.getElementById('sVal').innerText = e.target.value;
        document.getElementById('vIn').oninput = (e) => document.getElementById('vVal').innerText = e.target.value;
        document.addEventListener('mousedown', (e) => { if(e.button === 0) isFiring = true; });
        document.addEventListener('mouseup', () => isFiring = false);
        camera.rotation.order = 'YXZ';
        animate();
    </script>
</body>
</html>